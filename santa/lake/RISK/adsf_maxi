


Max, te pedimos agregar los siguientes campos:
1)ds_cys_descripcionsegmento
2)ds_cys_categoriaproducto
3)ds_cys_detallerenta
4)ds_cys_bucket

Tanto ds_cys_descripcionsegmento y ds_cys_detallerenta, salen de joinear el cod_per_nup con la tabla bi_corp_staging.malpe_ptb_pedt030 y este con nuestra parametria de segmentos (la cual en un futuro realmente cercano se va a switchear con una dimension cross en common)



SELECT
	trim(s.segmento_control) as ds_cys_descripcionsegmento,
	trim(s.detalle_renta) as ds_cys_detallerenta,
	case trim(s.segmento) when 'INDIVIDUOS' then p.categoria_particulares else p.categoria_carterizados end as ds_cys_categoriaproducto,
	case 
	when coalesce(CAST(dias_atraso AS INT),0) = 0 then '0' 
	when CAST(dias_atraso AS INT) >= 1 AND CAST(dias_atraso AS INT)<= 30 then '1-30' 
	when CAST(dias_atraso AS INT) >= 30 AND CAST(dias_atraso AS INT) <= 60 then '31-60' 
	when CAST(dias_atraso AS INT) >= 61 AND CAST(dias_atraso AS INT)<= 90 then '61-90' 
	when CAST(dias_atraso AS INT) >= 91 AND CAST(dias_atraso AS INT) <= 120 then '91-120' 
	when CAST(dias_atraso AS INT) >= 121 AND CAST(dias_atraso AS INT)<= 150 then '121-150' 
	when CAST(dias_atraso AS INT)>= 151 AND CAST(dias_atraso AS INT)<= 180 then '151-180' else 'MAS DE 180' end as ds_cys_bucket
FROM 
bi_corp_staging.rio125_adsf_cartera T1
LEFT JOIN 
bi_corp_staging.malpe_ptb_pedt030 p30 
on 
TRIM(T1.nup) =TRIM(p30.penumper) 
and 
p30.partition_date = '{{ ti.xcom_pull(task_ids='InputConfig', key='partition_date', dag_id='xxxxxxxxxxx') }}'
LEFT JOIN
bi_corp_staging.risksql5_segmentos s 
ON 
trim(p30.pesegcla) = trim(s.ramo) 
and 
s.fecha_informacion = '{{ ti.xcom_pull(task_ids='InputConfig', key='partition_date', dag_id='xxxxxxxxxxx') }}'
LEFT JOIN 
bi_corp_staging.risksql5_productos p 
ON 
trim(T1.producto) = trim(p.codigo_producto) 
and
trim(T1.subprod) = trim(p.codigo_subproducto)  
and 
p.fecha_informacion = '{{ ti.xcom_pull(task_ids='InputConfig', key='partition_date', dag_id='xxxxxxxxxxx') }}'
